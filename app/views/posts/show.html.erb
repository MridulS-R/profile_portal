<div class="row g-3">
  <div class="col-12 d-flex justify-content-between align-items-center">
    <h1 class="h3 mb-0"><%= @post.title %></h1>
    <div class="d-flex gap-2">
      <% if user_signed_in? && @post.user_id == current_user.id %>
        <%= link_to "Edit", edit_post_path(@post), class: "btn btn-outline-secondary btn-sm" %>
        <%= button_to "Delete", post_path(@post), method: :delete, data: { confirm: "Delete this post?" }, class: "btn btn-outline-danger btn-sm" %>
      <% end %>
      <%= link_to "Back", posts_path, class: "btn btn-outline-primary btn-sm" %>
    </div>
  </div>
  <div class="col-12 text-muted small">Published <%= time_ago_in_words(@post.published_at || @post.created_at) %> ago by <%= @post.user.name %></div>
  <div class="col-12">
    <div class="card shadow-sm card-pressable">
      <div class="card-body">
        <%= @post.rendered_body.html_safe %>
      </div>
    </div>
  </div>
  <div class="col-12 d-flex gap-2 align-items-center mt-2">
    <%= button_to '👍 Like', react_post_path(@post, kind: 'like'), method: :post, class: 'btn btn-sm btn-outline-success' %>
    <%= button_to '👎 Dislike', react_post_path(@post, kind: 'dislike'), method: :post, class: 'btn btn-sm btn-outline-danger' %>
    <span class="badge text-bg-light">Likes: <%= @post.reactions.where(kind: 'like').count %></span>
    <span class="badge text-bg-light">Dislikes: <%= @post.reactions.where(kind: 'dislike').count %></span>
  </div>

  <div class="col-12 mt-3">
    <h2 class="h5">Comments</h2>
    <% if @post.user.respond_to?(:allow_comments) && !@post.user.allow_comments %>
      <div class="alert alert-warning">Comments are disabled by the author.</div>
    <% else %>
      <% if user_signed_in? %>
        <%= form_with url: post_post_comments_path(@post), method: :post, local: true do |f| %>
          <div class="mb-2">
            <%= f.text_area :body, rows: 3, class: 'form-control', placeholder: 'Add a comment...' %>
          </div>
          <%= f.submit 'Post Comment', class: 'btn btn-sm btn-primary' %>
        <% end %>
      <% else %>
        <div class="alert alert-info">Please log in to comment.</div>
      <% end %>
    <% end %>
    <div class="mt-3">
      <% @post.comments.includes(:user).order(created_at: :desc).each do |c| %>
        <div class="border rounded p-2 mb-2">
          <div class="small text-muted d-flex justify-content-between">
            <span><%= c.user.name %> • <%= time_ago_in_words(c.created_at) %> ago</span>
            <% if user_signed_in? && (c.user_id == current_user.id || @post.user_id == current_user.id) %>
              <%= button_to 'Delete', post_post_comment_path(@post, c), method: :delete, class: 'btn btn-sm btn-outline-danger' %>
            <% end %>
          </div>
          <div><%= simple_format(c.body) %></div>
        </div>
      <% end %>
    </div>
  </div>
  <div class="col-md-4 order-md-2">
    <div class="card shadow-sm">
      <div class="card-body d-flex align-items-center gap-3">
        <% if @post.user.avatar_url.present? %>
          <img src="<%= @post.user.avatar_url %>" class="rounded-circle border" alt="Avatar" width="48" height="48">
        <% end %>
        <div>
          <div class="fw-semibold"><%= @post.user.name %></div>
          <% if @post.user.github_username.present? %>
            <div class="text-muted small">@<%= @post.user.github_username %></div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-8 order-md-1">
    <% if @post.category || @post.tags.any? %>
      <div class="mb-3">
        <% if @post.category %>
          <span class="chip me-2"><span class="dot"></span> <%= @post.category.name %></span>
        <% end %>
        <% @post.tags.each do |t| %>
          <%= link_to t.name, posts_path(tag: t.slug), class: 'chip me-1' %>
        <% end %>
      </div>
    <% end %>
  </div>
</div>
